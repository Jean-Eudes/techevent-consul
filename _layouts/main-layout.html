<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Techevent-consul by Jean-Eudes</title>
    <link rel="stylesheet" href="../stylesheets/styles.css">
    <link rel="stylesheet" href="../stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="../stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

</head>

<body>
<div id="header">
    <nav>
        <li class="fork"><a href="https://github.com/Jean-Eudes/techevent-consul">View On GitHub</a></li>
        <li class="downloads"><a href="https://github.com/Jean-Eudes/techevent-consul/zipball/master">ZIP</a></li>
        <li class="downloads"><a href="https://github.com/Jean-Eudes/techevent-consul/tarball/master">TAR</a></li>
        <li class="title">DOWNLOADS</li>
    </nav>
</div><!-- end header -->

<div class="wrapper">

    <section id="main-content">
        <h2>Workshop : Service discovery &amp; Consul
        </h2>


        <p>Dans ce workshop, vous aurez à disposition 4 instances Amazon servant respectivement à :
        <ul>
            <li>1 instance de consul en mode server</li>
            <li>2 instances contenant 2 service web</li>
            <li>1 instance servant à répartir la charge entre les deux instances de service web</li>
        </ul>

        {% include tuto-consul.html %}

        <p>Template {{page.group}}</p>
    </section>

    <section>
        Consul est un outil de service discovery, permettant à des services de s'enregistrer auprès d'un serveur, et à d'autres services d'interroger ce même serveur pour récupérer des informations sur les services déployés sur notre cluster

        <h2>Introduction</h2>

        Il y a quelques mois, votre entreprise a suivie le dernier buzz word à la mode suite à une université à devoxx france, et à décider de se lancer dans l’aventure des micro services. De très nombreux micro services plus tard, un problème est apparu : comment connaître l’adresse de mes services. Après consultation du pôle architecture de notre société, suivi par de trop nombreuses réunions, il a été décidé de mettre en place une solution de service discovery.

        <h3>Téléchargement de la clef privé</h3>


        <p>Pour vous connecter aux machines, récupérer le fichier <a href="https://raw.github.com/Jean-Eudes/techevent-consul/master/script/consul.pem">graphite.pem</a> ou le fichier <a href="https://raw.github.com/Jean-Eudes/techevent-consul/master/script/consul.ppk">graphite.ppk</a> pour les utilisateurs Windows, dans votre répertoire courant (la clef sera révoquée après le workshop). N'oubliez pas de changer les permissions sur le fichier :</p>

        <h4>Pour Linux ou Mac :</h4>

        {% highlight bash %}
        $ chmod 600 graphite.pem
        {% endhighlight %}


        {% highlight bash %}
        $ ssh -i consul.pem ec2-user@{{page.group}}-server.consul.aws.xebiatechevent.info
        {% endhighlight %}

        <h4>Pour windows :</h4>
        <ul>
            <li>Si vous ne l'avez pas, récupérez <a href="http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe">PuTTY</a></li>
            <li>Entrez l'adresse <em>{{page.group}}-server.consul.aws.xebiatechevent.info</em> à l'emplacement de l'encadré rouge ci-dessous</li>
        </ul>

        <img src="../images/putty_ip.png" alt="putty ip"/>

        <ul>
            <li>Suivez ensuite les screenshots suivants :</li>
        </ul>

        <img src="../images/putty_user.png" alt="putty2"/>
        <img src="../images/putty_key1.png" alt="putty3"/>
        <img src="../images/putty_key2.png" alt="putty4"/>
        <img src="../images/putty_open_connection.png" alt="putty5"/>



        ## Installation de consul (étape déjà faite pour ce techeveny)

        Consul est livré sous la forme d’un simple binaire. Il suffit simplement de le télécharger :

        {% highlight bash %}
$ wget https://dl.bintray.com/mitchellh/consul/0.6.4_linux_amd64.zip
        {% endhighlight %}

    </section>

    <section>
        <h2>Lancement du serveur consul</h2>

        Nous allons maintenant lancer notre serveur consul, en spécifiant que nous ne lançons que une instance (pas de redondance), et qu’il sera accessible depuis l’extérieur.

        Pour celà, connectez vous sur le serveur consul

        {% highlight bash %}
$ ssh -i consul.pem ec2-user@{{page.group}}-server.consul.aws.xebiatechevent.info
        {% endhighlight %}

        et lancer le serveur :
        {% highlight bash %}
$ consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul --client 0.0.0.0 -ui-dir ui -config-dir etc/consul.d  > log &
        {% endhighlight %}

        Il est possible de regarder l’état du serveur avec la commande

        {% highlight bash %}
$ consul members
        {% endhighlight %}

    </section>

    <section>
        <h2>Lancement de l'agent consul</h2>

        On va maintenant ajouter un agent consul et le connecter à notre serveur. Connectez vous à votre machine web1, et lancer l'agent consul

        {% highlight bash %}
$ ssh -i consul.pem ec2-user@{{page.group}}-web1.consul.aws.xebiatechevent.info
        {% endhighlight %}


        {% highlight bash %}
$ mkdir -p etc/consul.d
$ consul agent -data-dir /tmp/consul -node=agent1 -config-dir etc/consul.d > log &
$ consul join <addr_ip_privé_serveur/>
        {% endhighlight %}

        Si vous demandez maintenant à consul de vous affichez l’état du cluster, vous verrez bien apparaître deux lignes, une pour le serveur, et une pour le client.

        Consul propose également une api rest pour connaître l’état du cluster

        {% highlight bash %}
$ curl localhost:8500/v1/catalog/nodes
        {% endhighlight %}


        Il est également possible de voir l’état du cluster en se connectant à l’interface web :

        {% highlight bash %}
$ http://{{page.group}}-server.consul.aws.xebiatechevent.info:8500/ui/
        {% endhighlight %}

    </section>

    <section>
        <h2>Création de notre premier service</h2>

Avec consul, la création d’un service passe par la création d’un fichier json décrivant le service. Dans le répertoire /etc/consul.d de la machine contenant l’agent, créer un fichier nommé web.json avec le contenu suivant :

{% highlight javascript %}
{"service":
{
"name": "web",
"tags": ["web"], "port": 8000}
}
{% endhighlight %}

Lancer ensuite la commande consul reload pour demander à consul de recharger la configuration.

{% highlight bash %}
consul reload
{% endhighlight %}

Vous pouvez voir dans l’interface qu'un nouveau service est apparu.

    </section>

    <section>
        <h3>Interroger consul</h3>
Consul met à disposition deux interfaces pour avoir accès aux informations d’un service :
- un service REST
- un serveur DNS.

Essayer de récupérer les informations de votre service avec les deux interfaces disponibles.

[lien vers la documentation de l'api REST](https://www.consul.io/docs/agent/http/catalog.html)

[lien vers la documentation de l'interface DNS](https://www.consul.io/docs/agent/dns.html)


<div class = 'solution'>
{% highlight bash %}
curl localhost:8500/v1/catalog/service/web
dig @127.0.0.1 -p 8600 web.service.consul
{% endhighlight %}
</div>

Remarque: Consul est aussi capable d'utiliser le protocole DNS SRV, qui permet notamment d’accéder en plus de l’adresse IP au port du serveur demandé :

<div class = 'solution'>
{% highlight bash %}
dig @127.0.0.1 -p 8600 web.service.consul SRV
{% endhighlight %}
</div>

    </section>


</div>
<!--[if !IE]><script>fixScale(document);</script><![endif]-->

</body>


</html>